---
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: C:/Users/Devan.McGranahan/GoogleDrive/latex/templates/Rmd-template_scrartcl_SanSerif.tex
title: "Supplementary information"
subtitle: "Data plots & R script"
date: "`r Sys.Date()`"
author:
- name: DA McGranahan
  affiliation: School of Natural Resource Sciences, Range Science; North Dakota State University, Fargo, ND
- name: BN Poling
  affiliation: School of Natural Resource Sciences, Range Science; North Dakota State University, Fargo, ND
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning=FALSE, message = FALSE, fig.keep = 'last', fig.show = 'hide', fig.path='figures/', dev=c('png'))
if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, magrittr, xtable) 

source('C:/Users/devan.mcgranahan/GoogleDrive/Research/Projects/FireDependentEcosystems/figures/Rscripts/CustomThemes.R')

grass.combined <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vTS7XPynyjgRkghaf8dMI1k1mPoT9qa1VZNoexYfBvofRjItm3CnYXnIC_Yv5zGF8moqUu-NxRJbMyX/pub?gid=1407150711&single=true&output=csv")

d_fp = "C:/Users/Devan.McGranahan/GoogleDrive/Students/Brittany/Data & Script/Ch.3 - Dust_"

aic_cap = "Results of AICc-based ranking of linear mixed-effect regression models comparing perennial grass biomass recovery by species, dust application, photosynthetic pathway (C3/C4), interactions between these variables, and a null, intercept-only model."
crop_cap = "Results of AICc-based ranking of linear mixed-effect regression models comparing four physiological responses by species, dust application, an additive multiple-regression model, and a multiple regression model with an interaction term, against a null, intercept-only model."

```

\newpage 
# Annual crops 

## Raw data

\begin{figure}[!h]
  \centering
  \includegraphics[width=0.9\textwidth]{figures/chlorconc.jpg}\\
  \includegraphics[width=0.9\textwidth]{figures/photoact.jpg}\\
  \caption{\textbf{TOP:} Chlorophyll concentration; \textbf{BOTTOM:} Photosynthetic yield. }
\end{figure}

\clearpage 

\begin{figure}[!h]
  \centering
  \includegraphics[width=0.9\textwidth]{figures/stomcond.jpg}\\
  \includegraphics[width=0.9\textwidth]{figures/SLA.jpg}
  \caption{\textbf{TOP:} Stomatal conductance; \textbf{BOTTOM:} Specific leaf area. }
\end{figure}

\clearpage 

## Short-term responses

```{r st_crop_data_loading}
#Conductance
cond <- bind_rows(
          read_csv(paste0(d_fp, "/Data_csv/2/Por_2.csv")),
          read_csv(paste0(d_fp, "/Data_csv/3/Por_3.csv"))
        ) %>%
        slice(1:1112) %>%
        select(block, spp, date, t_c, pre_post, conductance) %>%
        rename(value = conductance) %>%
        mutate(response = "cond")

#Chlorophyll 
conc <- bind_rows(
            read_csv(paste0(d_fp, "/Data_csv/2/CCM_2_.csv")), 
            read_csv(paste0(d_fp, "/Data_csv/3/CCM_3_.csv"))
          ) %>%
        slice(1:1699) %>%         
          select(block, spp, date, t_c, pre_post, concentration) %>%
          rename(value = concentration) %>%
          mutate(response = "conc")

#Quantum yield
yield <- bind_rows(
              read_csv(paste0(d_fp, "/Data_csv/2/OS1_2_.csv")), 
              read_csv(paste0(d_fp, "/Data_csv/3/OS1_3_.csv"))
            ) %>%
              slice(1:1680) %>% 
              select(block, spp, date, t_c, pre_post, yield) %>%
              rename(value = yield) %>%
              mutate(response = "yield")
resp_crop <- bind_rows(cond, conc, yield) 

diff_dat <- 
  resp_crop %>%
    filter(pre_post != "na") %>% 
          mutate(round = case_when(
            date %in% c("8/24/16","9/21/16" ) ~ "1", 
            date %in% c("8/26/16","9/23/16" ) ~ "2", 
            date %in% c("8/29/16","9/26/16" ) ~ "3", 
            date %in% c("8/31/16","9/28/16" ) ~ "4", 
            date %in% c("9/2/16","9/30/16" ) ~ "5"   )) %>%
          group_by(round, block, spp, pre_post) %>%
          mutate(sample = seq(1, n())) %>%
          ungroup %>%
          pivot_wider(names_from = pre_post, 
                      values_from = value) %>%
          mutate(diff = post - pre) %>%
          select(-date, -t_c, -pre, -post, -sample) %>% 
          filter(!is.na(diff) ) %>%
             mutate(diff = as.numeric(scale(diff, center = F)))  
diff_dat <- 
  diff_dat %>% 
    group_by(response, block, round, spp) %>%
      mutate(pot = seq(1,n(), 1))
```

```{r st_crop_dist, eval=FALSE}
# Distributions
  # stomatal conductance

    MASS::fitdistr(filter(diff_dat, 
                          response == "cond", 
                          diff <= 600, 
                          diff >= -1000)$diff, 
                   "normal") 
  
    diff_dat %>%
      filter(response == "cond") %>%
      filter(diff <= 600, diff >= -1000) %>%
      ggplot(aes(x=diff)) + theme_bw(14) + 
      geom_density(alpha=0.9,
                   color = "black", 
                   fill="#FF6666")+ 
      geom_histogram(aes(y=..density.., 
                         fill = spp),  
                     alpha = 0.5,
                     binwidth=10, 
                     show.legend = F) +
      stat_function(data = diff_dat %>%
                      filter(diff <= 600, diff >= -1000) %>%
                      filter(response == "cond"), 
                    fun= dnorm , 
                    args=list(mean=3.3, 
                              sd=192),
                    colour="blue", size=1)
  # Photosynthetic yield
    MASS::fitdistr(filter(diff_dat, 
                          response == "yield", 
                          diff <= 0.5)$diff, 
                   "normal") 
    
    diff_dat %>%
      filter(response == "yield") %>%
      filter(diff <= 0.5) %>%
      ggplot(aes(x=diff)) + theme_bw(14) + 
      geom_density(alpha=0.9,
                   color = "black", 
                   fill="#FF6666")+ 
      geom_histogram(aes(y=..density.., 
                         fill = spp),  
                     alpha = 0.5,
                     binwidth=0.01, 
                     show.legend = F) +
      stat_function(data = diff_dat %>%
                      filter(diff <= 0.5) %>%
                      filter(response == "yield"), 
                    fun= dnorm , 
                    args=list(mean=0, 
                              sd=0.12),
                    colour="blue", size=1)
  # Chlorophyll content
    MASS::fitdistr(filter(diff_dat, 
                          response == "conc", 
                          diff != is.na(diff))$diff, 
                   "normal") 
    
    diff_dat %>%
      filter(response == "conc") %>%
      #filter(diff <= 0.5) %>%
      ggplot(aes(x=diff)) + theme_bw(14) + 
      geom_density(alpha=0.9,
                   color = "black", 
                   fill="#FF6666") + 
      geom_histogram(aes(y=..density.., 
                         fill = spp),  
                     alpha = 0.5,
                     binwidth=10, 
                     show.legend = F) +
      stat_function(data = diff_dat %>%
                      filter( response == "conc", 
                              diff != is.na(diff) ), 
                    fun= dnorm , 
                    args=list(mean=33.12, 
                              sd=83.9),
                    colour="blue", size=1)
```

```{r diff_gg, fig.show='asis', fig.cap="Immediate changes (after dusting values - pre-dusting values) in three physiological responses among 7 annual crop species over 5 dust application events that occurred 3 days apart. Colors indicate two blocks on different greenhouse benches."}
diff_dat %>%
  group_by(round, block, spp, response) %>%
  summarise(Mean = mean(diff), 
            SE = sd(diff)/sqrt(n())) %>%
  ggplot(aes(x = round)) + theme_bw(16) + 
  geom_hline(yintercept = 0, lty=2) + 
  geom_line(aes(y=Mean, color = block, 
                group = block), 
            alpha = 0.25) + 
  geom_errorbar(aes(ymin = Mean - SE, 
                    ymax = Mean + SE, 
                    color = block), 
                width = 0.25, 
                position = position_dodge(width = 0.1)) + 
  geom_point(aes(y = Mean, 
                 fill = block), 
             pch = 21, color = "darkgrey", 
             position = position_dodge(width = 0.1)) + 
  labs(y = "Change due to immediate dust effect\n(mean +/- s.e.)", 
       x = "Dust application event") + 
  facet_grid(response ~ spp, scales = "free") +
  theme(legend.position = "none")
```

```{r st_crop_mods}
#
# Annual crops 
#
#
# Short-term responses
#
#
# Regresion modelling 
#
# Model fitting 
#
# Responses by species 
#
  # Chlorophyll concentration  
    conc0 <- lme4::lmer(diff ~ 0 + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "conc")) 
    conc1 <- lme4::lmer(diff ~ 0 + spp + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "conc")) 

    conc_diff_CI <- as.data.frame(confint(conc1)) %>%
                      rownames_to_column("term") %>%
                      slice(-(1:2)) %>%
                      bind_cols(tibble(
                        estimate = lme4::fixef(conc1), 
                        response = "Chlorophyll\nconcentration") ) 
  # Stomatal conductance
    cond0 <- lme4::lmer(diff ~ 0 + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "cond")) 
    cond1 <- lme4::lmer(diff ~ 0 + spp + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "cond")) 
    
    cond_diff_CI <- as.data.frame(confint(cond1)) %>%
                      rownames_to_column("term") %>%
                      slice(-(1:2)) %>%
                      bind_cols(tibble(
                        estimate = lme4::fixef(cond1), 
                        response = "Stomatal\nconductance") ) 
  # Photosynthetic yield
    yield0 <- lme4::lmer(diff ~ 0 + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "yield")) 
    yield1 <- lme4::lmer(diff ~ 0 + spp + (1|block:round:pot), REML = F,
                        data = filter(diff_dat, response == "yield")) 
    
    yield_diff_CI <- as.data.frame(confint(yield1)) %>%
                      rownames_to_column("term") %>%
                      slice(-(1:2)) %>%
                      bind_cols(tibble(
                        estimate = lme4::fixef(yield1), 
                        response = "Photosynthetic\nyield") ) 
    diffCIs <- bind_rows(cond_diff_CI, 
                        conc_diff_CI, 
                        yield_diff_CI) 
    colnames(diffCIs) <- c("term", "ciL", "ciU", "estimate", "response")
#
# Overall responses
#
    diff0 <- lme4::lmer(diff ~ 0 + (1|block:round:spp), 
                        data= diff_dat, REML = F) 
    diff1 <- lme4::lmer(diff ~ 0 + response + (1|block:round:spp), 
                        data= diff_dat, REML = F) 
    dmc <- anova(diff0, diff1)

    diff_CI <- as.data.frame(confint(diff1)) %>%
                rownames_to_column("term") %>%
                slice(-(1:2)) %>%
                bind_cols(tibble(
                  estimate = lme4::fixef(diff1)) )
    colnames(diff_CI) <- c("term", "ciL", "ciU", "estimate")
```

```{r diff_mod_comp, results='asis'}
  dmc  %>%
   xtable(digits=c(1,0,1,1,1,1,1,0,3), 
               caption = 'Immediate physiological responses to dusting vary among response measurements.') %>%
  print(comment = F)
  #     include.rownames=FALSE, floating=T, 
  #     sanitize.colnames.function=identity,
  #        comment = F, 
  #        file ="GrassAICtab.tex") 
```

```{r st_CI_gg, fig.keep='all'}
# Plotting    
  diffCIs %>%
    mutate_at(vars(ciL:estimate), ~ round(., 5)) %>%
    mutate(term = factor(term, 
                         levels=c("sppBA", "sppDW",
                                  "sppCO", "sppSO",
                                  "sppLE", "sppPB",
                                  "sppSF"),
                         labels=c("Barley (C3)", "Wheat (C3)",
                                  "Maize (C4)", "Sorghum (C4)",
                                  "Lentil", "Pinto bean",
                                  "Sunflower")) )  %>%
  ggplot() +
    coord_flip() +  theme_bw(12) +
    geom_hline(yintercept = 0, lty=2) + 
        geom_errorbar(aes(x=response,
                 ymin=ciL, ymax=ciU), 
                   width=0.25, size=1.5, color=cbPal5[3]) +
     geom_point(aes(x=response, y=estimate), 
                size=4.5, pch=21, stroke = 1.5, 
                color="black", fill = cbPal5[3]) + 
     labs(y="Dust effect", 
          title = "Responses by species (immediate)") +
    ylim(c(-1.1,1.1)) + 
      facet_wrap(~ term, nrow = 2) + 
     theme(panel.grid.major.y = element_blank(),
           axis.title.y = element_blank(), 
           axis.text.y = element_text(color="black")) 

diff_CI %>%
  mutate(term = recode(term, 
                       responseconc = "Chlorophyll concentration", 
                       responsecond = 'Stomatal conductance', 
                       responseyield = 'Photosynthetic yield')) %>%
   ggplot() +
   coord_flip() +  theme_bw(16) +
  geom_hline(yintercept = 0, lty=2) + 
      geom_errorbar(aes(x=term,
               ymin=ciL, ymax=ciU), 
                 width=0.25, size=1.5, color=cbPal5[3]) +
   geom_point(aes(x=term, y=estimate), 
              size=4.5, pch=21, stroke = 1.5, 
              color="black", fill = cbPal5[3]) + 
   labs(y="Dust effect", 
        title = "Overall responses") +
   theme(panel.grid.major.y = element_blank(),
         axis.title.y = element_blank(), 
         axis.text.y = element_text(color="black")) 

```

```{r data_loading, include=FALSE}
#Specific leaf area
  SLA.dat <- bind_rows(
                read_csv(paste0(d_fp, "/Data_csv/2/SLA_2.csv")),  
                read_csv(paste0(d_fp, "/Data_csv/3/SLA_3.csv"))
                        )        
  SLA2 <- SLA.dat[(1:672),c(1:3,8)] %>%
             mutate(lsla=log(SLA)) %>%
             filter(lsla>=4.5)

#Conductance
  Por.dat <- bind_rows(
                read_csv(paste0(d_fp, "/Data_csv/2/Por_2.csv")),
                read_csv(paste0(d_fp, "/Data_csv/3/Por_3.csv"))
                      )
  Por <- Por.dat[(1:1112),c(1:3,5,7,14)] %>%
            mutate(lcond=log(conductance + 1)) %>%
          group_by(block, t_c, spp) %>%
            mutate(pot = seq(1, n(), 1)) %>%
          ungroup

#Chlorophyll 
  CCM.dat <- bind_rows(
                read_csv(paste0(d_fp, "/Data_csv/2/CCM_2.csv")), 
                read_csv(paste0(d_fp, "/Data_csv/3/CCM_3.csv"))
                        )
  
  CCM2 <- CCM.dat[(1:1699),c(1:5,10)]  %>%
           mutate(lconc=log(concentration + 1)) %>%
           filter(lconc>=4) %>%
          group_by(block, t_c, spp) %>%
            mutate(pot = seq(1, n(), 1)) %>%
          ungroup

#Quantum yield
  OS1.dat <- bind_rows(
              read_csv(paste0(d_fp, "/Data_csv/2/OS1_2.csv")), 
              read_csv(paste0(d_fp, "/Data_csv/3/OS1_3.csv"))
                       )
  OS1 <- OS1.dat[(1:1680),c(1:4,6,23)]
  OS1 %<>% filter(yield <= 0.999) %>%
            rename(pot = sample)
```

```{r lt_crop_dist, eval=FALSE}
# Specific leaf area
  ggplot(SLA2, aes(x=log(SLA))) + theme_bw() + 
   geom_histogram(aes(y=..density..),      
                  binwidth=.1, 
                  colour="black", fill="lightgreen") +
   geom_density(alpha=.2, fill="#FF6666")+ 
    stat_function(data=SLA2, fun= dnorm , 
               args=list(mean=5.86, sd=0.29),
              colour="red", size=1.1)

# Conductance
  ggplot(Por, aes(x=log(conductance + 1))) + theme_bw() + 
    geom_histogram(aes(y=..density.., fill=spp),      
                   binwidth=.1, 
                   colour="black") +
    geom_density(alpha=.2) 

# Chlorophyll 
  ggplot(CCM2, aes(x=lconc)) + theme_bw() + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.1, 
                   colour="black", fill="lightgreen") + 
    geom_density(alpha=.2, fill="#FF6666")  + 
    stat_function(data=CCM2, fun= dnorm , 
                  args=list(mean=5.8, sd=0.3),
               colour="blue", size=1.1) 

# Quantum yield
  ggplot(OS1, aes(x=yield)) + theme_bw() + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.03, 
                   colour="black", fill="lightgreen") +
    geom_density(alpha=.2, fill="#FF6666") + xlim(c(0,1))  +  
    stat_function(data=OS1, fun= dnorm , 
              args=list(mean=0.59, sd=0.16),
   #args = list(mean=-0.57,sd=0.32),  
                colour="blue", size=1.1) + 
    stat_function(data=OS1, fun = dgamma, 
                        args=list(shape=(11.4), 
                                  rate=(19.3)),
                        colour="red", size=1.1) 
```

```{r crop_mod_fits}
#
#  Long-term responses
#
# Mixed-effect model fitting
  # Specific leaf area
    sla.null <- lme4::lmer(scale(log(SLA)) ~ 1 + (1|block), 
                           data=SLA2, REML=FALSE)
    sla.spp <- lme4::lmer(scale(log(SLA)) ~ spp + (1|block), 
                          data=SLA2, REML=FALSE)
    sla.treat <- lme4::lmer(scale(log(SLA)) ~ t_c + (1|block), 
                            data=SLA2, REML=FALSE)
    sla.add <- lme4::lmer(scale(log(SLA)) ~ 0 + spp + t_c + (1|block), 
                          data=SLA2, REML=FALSE)
    sla.int <- lme4::lmer(scale(log(SLA)) ~ 0 + spp * t_c + (1|block), 
                          data=SLA2, REML=FALSE)
  # Stomatal conductance
    conduct.null <- lme4::lmer(scale(lcond) ~ 1 + (1|block:date:pot),
                               data=Por, REML=FALSE)
    conduct.spp <- lme4::lmer(scale(lcond) ~ spp + (1|block:date:pot), 
                              data=Por, REML=FALSE)
    conduct.treat <- lme4::lmer(scale(lcond) ~ t_c + (1|block:date:pot), 
                                data=Por, REML=FALSE)
    conduct.add <- lme4::lmer(scale(lcond) ~ 0 + spp + t_c + (1|block:date:pot), 
                              data=Por, REML=FALSE)
    conduct.int <- lme4::lmer(scale(lcond) ~ 0 + spp * t_c  + (1|block:date:pot), 
                              data=Por, REML=FALSE)
  # Chlorophyll content
    conc.null <- lme4::lmer(scale(lconc) ~ 1 + (1|block:date:pot), 
                            data=CCM2, REML=FALSE)
    conc.spp <- lme4::lmer(scale(lconc) ~ spp + (1|block:date:pot), 
                           data=CCM2, REML=FALSE)
    conc.treat <- lme4::lmer(scale(lconc) ~ t_c + (1|block:date:pot), 
                             data=CCM2, REML=FALSE)
    conc.add <- lme4::lmer(scale(lconc) ~ 0 + spp + t_c + (1|block:date:pot), 
                           data=CCM2, REML=FALSE)
    conc.int <- lme4::lmer(scale(lconc) ~ 0 + spp*t_c + (1|block:date),
                           data=CCM2, REML=FALSE)
  # Quantum yield
    yield.null <- lme4::lmer(scale(yield)~ 1 + (1|block:date:pot), 
                             data=OS1, REML=FALSE)
    yield.spp <- lme4::lmer(scale(yield)~ spp + (1|block:date:pot), 
                            data=OS1, REML=FALSE)
    yield.treat <- lme4::lmer(scale(yield)~ t_c + (1|block:date:pot), 
                              data=OS1, REML=FALSE)
    yield.add <- lme4::lmer(scale(yield)~ 0 + spp + t_c + (1|block:date:pot), 
                            data=OS1, REML=FALSE)
    yield.int <- lme4::lmer(scale(yield) ~ 0 + spp*t_c + (1|block:date:pot), 
                            data=OS1, REML=FALSE)
```


```{r crop_mod_sel}
# AICc-based model selection 
  # Specific leaf area 
    sla.mod.names <- c("sla.null", "sla.spp", 
                       "sla.treat", "sla.add",
                       "sla.int")
    sla.mods <- lst( )
    
   for(i in 1:length(sla.mod.names)) {
    sla.mods[[i]] <- get(sla.mod.names[i]) }
  sla_aic_tab <- AICcmodavg::aictab(cand.set = sla.mods, 
                                    modnames = sla.mod.names) 
  # Conductance
    conduct.mod.names <- c("conduct.null", "conduct.spp", 
                           "conduct.treat", "conduct.add", 
                           "conduct.int")
    conduct.mods <- lst( )
    
     for(i in 1:length(conduct.mod.names)) {
        conduct.mods[[i]] <- get(conduct.mod.names[i]) }
      cond_aic_tab <- AICcmodavg::aictab(cand.set = conduct.mods, 
                                         modnames = conduct.mod.names)
  # Chlorophyll 
    conc.mod.names <- c("conc.null", "conc.spp", 
                        "conc.treat", "conc.add", 
                        "conc.int")
    conc.mods <- lst( )
    
     for(i in 1:length(conc.mod.names)) {
      conc.mods[[i]] <- get(conc.mod.names[i]) }
     conc_aic_tab <- AICcmodavg::aictab(cand.set = conc.mods, 
                                        modnames = conc.mod.names)
  # Photosynthetic yield
    yield.mod.names <- c("yield.null", "yield.spp", 
                         "yield.treat", "yield.add", 
                         "yield.int")
    yield.mods <- lst( )
    
    for(i in 1:length(yield.mod.names)) {
      yield.mods[[i]] <- get(yield.mod.names[i]) }
    yld_aic_tab <- AICcmodavg::aictab(cand.set = yield.mods, 
                                      modnames = yield.mod.names)

```


```{r crop_mod_tab, results='asis'}
    sla_aic <- 
      sla_aic_tab %>% as_tibble %>%
                        mutate(Modnames = as.character(Modnames)) %>%
       mutate(Modnames = recode(Modnames, 
                              sla.null = 'null (Intercept only)' , 
                              sla.spp = "species", 
                              sla.treat = "dust" , 
                              sla.add = "species + dust", 
                              sla.int = "species x dust")) %>%
         rename(Model = Modnames, 
                `$\\Delta$AICc` = Delta_AICc) %>%
      bind_cols(tibble(Response = c("Specific leaf area", "","","","")), 
                .) 

    cond_aic <- 
      cond_aic_tab %>% as_tibble %>%
                        mutate(Modnames = as.character(Modnames)) %>%
       mutate(Modnames = recode(Modnames, 
                              conduct.null = 'null (Intercept only)' , 
                              conduct.spp = "species", 
                              conduct.treat = "dust" , 
                              conduct.add = "species + dust", 
                              conduct.int = "species x dust")) %>%
         rename(Model = Modnames, 
                `$\\Delta$AICc` = Delta_AICc) %>%
      bind_cols(tibble(Response = c("Stomatal conductance", "","","","")), 
                .)

    conc_aic <- 
        conc_aic_tab %>% as_tibble %>%
                          mutate(Modnames = as.character(Modnames)) %>%
         mutate(Modnames = recode(Modnames, 
                                conc.null = 'null (Intercept only)' , 
                                conc.spp = "species", 
                                conc.treat = "dust" , 
                                conc.add = "species + dust", 
                                conc.int = "species x dust")) %>%
           rename(Model = Modnames, 
                  `$\\Delta$AICc` = Delta_AICc) %>%
      bind_cols(tibble(Response = c("Chlorophyll concentration", "","","","")), 
                .)

    yld_aic <- 
        yld_aic_tab %>% as_tibble %>%
                          mutate(Modnames = as.character(Modnames)) %>%
         mutate(Modnames = recode(Modnames, 
                                yield.null = 'null (Intercept only)' , 
                                yield.spp = "species", 
                                yield.treat = "dust" , 
                                yield.add = "species + dust", 
                                yield.int = "species x dust")) %>%
           rename(Model = Modnames, 
                  `$\\Delta$AICc` = Delta_AICc)%>%
      bind_cols(tibble(Response = c("Photosynthetic yield", "","","","")), 
                .)

bind_rows(conc_aic, cond_aic, yld_aic, sla_aic)  %>%
  select(-ModelLik, -LL) %>%
        as.data.frame %>%
    xtable( digits=c(1,1,0,0,1,1,2,2),
            caption = crop_cap, 
            label = "tab:cropAIC") %>%
  print( include.rownames=FALSE, 
         floating=T,
         sanitize.colnames.function=identity,
         table.placement = "!h",
         comment = F, 
         file ="CropAICtab.tex")


```

```{r lt_estimates}
#
# Estimating regression coefficients & 95% CIs
#
# By crop species 
  cond_CI <- as.data.frame(confint(conduct.int)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:9)) %>%
                    bind_cols(tibble(
                                estimate = lme4::fixef(conduct.int)[8:14], 
                                response = "Stomatal\nconductance") ) 
  conc_CI <- as.data.frame(confint(conc.int)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:9)) %>%
                 bind_cols(tibble(estimate = lme4::fixef(conc.int)[8:14], 
                                  response = "Chlorophyll\ncontent"))
  yield_CI <- as.data.frame(confint(yield.int)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:9)) %>%
                 bind_cols(tibble(estimate = lme4::fixef(yield.int)[8:14], 
                                  response = "Photosynthetic\nyield"))
  sla_CI <- as.data.frame(confint(sla.int)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:9)) %>%
                 bind_cols(tibble(estimate = lme4::fixef(sla.int)[8:14], 
                                  response = "Specific\nleaf area"))
  
 sppCIs <- bind_rows(cond_CI, 
            conc_CI, 
            yield_CI, 
            sla_CI) 
 colnames(sppCIs) <- c("term", "ciL", "ciU", "estimate", "response")
  
  sppCIs <- sppCIs %>%
          mutate(term = factor(term, 
                 levels=c("t_cT", "sppDW:t_cT",
                          "sppCO:t_cT", "sppSO:t_cT",
                          "sppLE:t_cT", "sppPB:t_cT",
                          "sppSF:t_cT"),
                labels=c("Barley (C3)", "Wheat (C3)",
                         "Maize (C4)", "Sorghum (C4)",
                         "Lentil", "Pinto bean",
                         "Sunflower")) ) 
#
# Overall dust effects
#
  # Specific leaf area (using model averaging) 

  sla.mod.names.top <- c("sla.spp", "sla.add")
  sla.mods.top <- lst( )
  	 for(i in 1:length(sla.mod.names.top)) {
    sla.mods.top[[i]] <- get(sla.mod.names.top[i]) }  
  
   sla.terms <- c("sppBA","sppDW", "sppPB",
  	               "sppSF", "sppCO", "sppLE",
  	               "sppSO", "t_cT" )
  	    sla.av.params <- as_tibble(array(NA,c(length(sla.terms),4)))
  	    colnames(sla.av.params)<-c("term","ciL","ciU","estimate")
  	   for(i in 1:length(sla.terms)) {
    	    sla.av <- AICcmodavg::modavg(parm = paste(sla.terms[i]), 
    	                 cand.set = sla.mods.top, 
    	                 modnames = sla.mod.names.top)
      	    sla.av.params[i,1] <- sla.terms[i]
      	    sla.av.params[i,4] <- round(sla.av$Mod.avg.beta, 2)
      	    sla.av.params[i,2] <- round(sla.av$Lower.CL, 3) 
      	    sla.av.params[i,3] <- round(sla.av$Upper.CL, 3) }
  	   
  	    
  conduct.add.CI <- as.data.frame(confint(conduct.add)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:2)) %>%
                    bind_cols(tibble(
                                estimate = lme4::fixef(conduct.add), 
                                response = "Stomatal\nconductance") ) 
  conc.add.CI <- as.data.frame(confint(conc.add)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:2)) %>%
                 bind_cols(tibble(estimate = lme4::fixef(conc.add), 
                                  response = "Chlorophyll\ncontent"))
  yield.add.CI <- as.data.frame(confint(yield.add)) %>%
                      rownames_to_column("term") %>%
                        slice(-(1:2)) %>%
                 bind_cols(tibble(estimate = lme4::fixef(yield.add), 
                                  response = "Photosynthetic\nyield"))
  
 cropCIs <- bind_rows(conduct.add.CI, 
            conc.add.CI, 
            yield.add.CI) 
 colnames(cropCIs) <- c("term", "ciL", "ciU", "estimate", "response")
  
cropCIs <- 
   sla.av.params %>% mutate(response = "Specific\nleaf area") %>%
      bind_rows(cropCIs)
```

```{r lt_CI_gg, fig.keep='all'}
  sppCIs %>%
  ggplot() +
  coord_flip() +  theme_bw(12) +
  geom_hline(yintercept = 0, lty=2) + 
      geom_errorbar(aes(x=response,
               ymin=ciL, ymax=ciU), 
                 width=0.25, size=1.5, color=cbPal5[3]) +
   geom_point(aes(x=response, y=estimate), 
              size=4.5, pch=21, stroke = 1.5, 
              color="black", fill = cbPal5[3]) + 
   labs(y="Dust effect", 
        title = "Responses by species (long-term)") +
  ylim(c(-1.1,1.1)) + 
    facet_wrap(~ term, nrow = 2) + 
   theme(panel.grid.major.y = element_blank(),
         axis.title.y = element_blank(), 
         axis.text.y = element_text(color="black")) 

  cropCIs %>%
    filter(term == "t_cT") %>%
  ggplot() +
   coord_flip() +  theme_bw(16) +
  geom_hline(yintercept = 0, lty=2) + 
      geom_errorbar(aes(x=response,
               ymin=ciL, ymax=ciU), 
                 width=0.25, size=1.5, color=cbPal5[3]) +
   geom_point(aes(x=response, y=estimate), 
              size=4.5, pch=21, stroke = 1.5, 
              color="black", fill = cbPal5[3]) + 
   labs(y="Dust effect", 
        title = "Overall responses") +
   theme(panel.grid.major.y = element_blank(),
         axis.title.y = element_blank(), 
         axis.text.y = element_text(color="black")) 

# cowplot::plot_grid(spp_gg, ov_gg, 
#                    nrow = 2, 
#                    rel_heights = c(2/3, 1/3))
```


\clearpage 


# Perennial Grasses

\begin{figure}[!h]
  \includegraphics[width=1\textwidth]{figures/grassrecovery.jpg}
  \caption{Biomass recovery for eight perennial grasses following two rounds of clipping under dusted and undusted conditions. }
\end{figure}


```{r grass_recovery, echo=FALSE, warning=FALSE}
recovery.dat <- 
  grass.combined %>% 
     mutate(r1=1-(gross0-gross1)/gross0, 
           r2=1-(gross0-gross2)/gross0,
           photo=ifelse(species=="AGCR"|species=="AGST"|
                         species=="SCAR"|species=="THIN", "C3","C4")) %>%
  select_at(vars(species:trt, r1:photo)) %>%
    pivot_longer(cols = c(r1, r2), 
                 values_to = "recovery", 
                 names_to = "event") 


recovery.dat$photo <- as.factor(recovery.dat$photo)
```

```{r grass_dist, warning=FALSE, eval=FALSE}
# MASS::fitdistr(recovery.dat$recovery, "normal")
ggplot(data=recovery.dat, aes(x=recovery)) + theme_bw() + 
  geom_histogram(aes(y=..density.., fill=event),     
                 binwidth=.05, 
                 colour="black") +
  geom_density(aes(fill=event),alpha=0.3, 
               fill="#FF6666") +
  stat_function(data=recovery.dat, 
                fun= dnorm , 
                  args=list(mean=0.79, sd=0.2),
                colour="green", size=1.1)
```

```{r gr_narrow_mod_set}
#
# Perennial grasses 
#
# Model fitting
  gr_null <- lme4::lmer(recovery~ 1 + (1|block:event:pot), 
                           data=recovery.dat, REML = F) 
  gr_trt <- lme4::lmer(recovery ~ trt + (1|block:event:pot),
                          data=recovery.dat, REML = F)
  gr_spp <- lme4::lmer(recovery ~  0 + species*trt + (1|block:event),
                          data=recovery.dat, REML = F)
  
  gr_photo <- lme4::lmer(recovery~ 0 + photo*trt + (1|block:event:pot),
                           data=recovery.dat, REML = F)
# AICc-based model selection
  rcv.mod.names <- c("gr_null", "gr_trt",
                      "gr_spp", "gr_photo")
  rcv.mods <- lst( )

   for(i in 1:length(rcv.mod.names)) {
    rcv.mods[[i]] <- get(rcv.mod.names[i]) }
   grass_aic_tab <- AICcmodavg::aictab(cand.set = rcv.mods, 
                                        modnames = rcv.mod.names) 
# Parameter extraction
  gr_params <- bind_cols(
                  confint(gr_spp) %>% 
                    as.data.frame %>% 
                    rownames_to_column("term") %>% 
                    slice(-c(1:2)), 
                  enframe(lme4::fixef(gr_spp)) %>% 
                    select(value) ) 
```

```{r gr_tables,  results='asis'}  
  gr_aic_df <- 
    grass_aic_tab %>% as_tibble %>%
                      mutate(Modnames = as.character(Modnames)) %>%
     mutate(Modnames = recode(Modnames, 
                            gr_null = 'null (Intercept only)' ,
                            gr_trt = "Dust exposure",
                            gr_spp= "species x dust", 
                            gr_photo= "C3/C4 x dust" )) %>%
       rename(Model = Modnames, 
              `$\\Delta$AICc` = Delta_AICc) %>%
    as.data.frame 
  
  print(xtable(gr_aic_df, 
               digits=c(1,1,1,1,1,1,1,1,1), 
               caption = aic_cap, 
               label = "tab:grassAIC"),
      include.rownames=FALSE, floating=T, 
      sanitize.colnames.function=identity,
         comment = F, 
         file ="GrassAICtab.tex") 
  colnames(gr_params) <- c("term", "ciL", "ciU", "estimate")
    gr_params %<>%
      as_tibble %>%
      slice(-c(1:8)) %>%
      mutate(photo= case_when(
                      term %in% c("speciesTHIN:trtT", 
                                  "speciesAGST:trtT", 
                                  "speciesSCAR:trtT", 
                                  "trtT") ~ "C3",
                      T ~ "C4"),
              term = factor(term, 
                           levels=c("speciesCYDA:trtT", "speciesPAVI:trtT",
                                    "speciesBODA:trtT", "speciesBOGR:trtT",
                                    "speciesTHIN:trtT", "speciesSCAR:trtT", 
                                    "speciesAGST:trtT",   "trtT"),
                          labels=c("Bermuda grass", "Switchgrass",
                                   "Buffalograss", "Blue grama",
                                   "Intermediate\nwheatgrass", 
                                   "Tall fescue",                                                                     "Creeping\nbentgrass", 
                                   "Crested\nwheatgrass")) )  
  
```

```{r gr_full_mod_set, results='asis', eval= FALSE}
# 
# Perennial grasses
#
# Mixed-effect model fitting
  gr_null <- lme4::lmer(recovery~ 1 + (1|block:event:pot), 
                           data=recovery.dat, REML = F)  
  gr_spp <- lme4::lmer(recovery~ 0 + species + (1|block:event:pot), 
                          data=recovery.dat, REML = F)
  gr_treat <- lme4::lmer(recovery~ 0 + trt + (1|block:event:pot), 
                            data=recovery.dat, REML = F)
  gr_phot <- lme4::lmer(recovery ~ 0 + photo + (1|block:event), 
                           data=recovery.dat, REML = F)
  gr_add <- lme4::lmer(recovery~ 0 + species+trt + (1|block:event:pot),
                          data=recovery.dat, REML = F)
  gr_add2 <- lme4::lmer(recovery ~ 0 + photo + trt  + (1|block:event:pot),
                           data=recovery.dat, REML = F)
  gr_int <- lme4::lmer(recovery~ 0 + species*trt + (1|block:event:pot),
                          data=recovery.dat, REML = F)
  gr_int2 <- lme4::lmer(recovery~ 0 + trt:photo + (1|block:event:pot),
                           data=recovery.dat, REML = F)
  
# AICc-based model selection
  rcv.mod.names <- c("gr_null","gr_spp", 
                     "gr_treat", "gr_phot", 
                     "gr_add", "gr_add2", 
                     "gr_int", "gr_int2")
  rcv.mods <- lst( )

   for(i in 1:length(rcv.mod.names)) {
    rcv.mods[[i]] <- get(rcv.mod.names[i]) }
   grass_aic_tab <- AICcmodavg::aictab(cand.set = rcv.mods, 
                                        modnames = rcv.mod.names) 

gr_aic_df <- 
  grass_aic_tab %>% as_tibble %>%
                    mutate(Modnames = as.character(Modnames)) %>%
   mutate(Modnames = recode(Modnames, 
                          gr_null = 'null (Intercept only)' , 
                          gr_spp= "species", 
                          gr_treat= "dust", 
                          gr_phot= "C3/C4", 
                          gr_add = "species + dust", 
                          gr_add2= "C3/C4 + dust", 
                          gr_int = "species + dust + species x dust", 
                          gr_int2 = "C3/C4 x dust")) %>%
     rename(Model = Modnames, 
            `$\\Delta$AICc` = Delta_AICc) %>%
  as.data.frame 

# Model averaging
  rcv.mod.names.top <- c("gr_spp", "gr_add")
  rcv.mods.top <- list( )
  	 for(i in 1:length(rcv.mod.names.top)) {
    rcv.mods.top[[i]] <- get(rcv.mod.names.top[i]) }  
  
   rcv.terms <- c("speciesAGCR", "speciesAGST", "speciesBODA", "speciesBOGR",
  	               "speciesCYDA", "speciesPAVI", "speciesSCAR",
  	               "speciesTHIN", "trtT" )
  	    rcv.av.params <- as_tibble(array(NA,c(length(rcv.terms),4)))
  	    colnames(rcv.av.params)<-c("term","estimate","ciL","ciU")
  	   for(i in 1:length(rcv.terms)) {
    	    rcv.av <- AICcmodavg::modavg(parm = paste(rcv.terms[i]), 
                    	                 cand.set = rcv.mods.top, 
                    	                 modnames = rcv.mod.names.top)
      	    rcv.av.params[i,1] <- rcv.terms[i]
      	    rcv.av.params[i,2] <- round(rcv.av$Mod.avg.beta, 2)
      	    rcv.av.params[i,3] <- round(rcv.av$Lower.CL, 3) 
      	    rcv.av.params[i,4] <- round(rcv.av$Upper.CL, 3) }
  
  rcv.av.params %<>%
    mutate(term = factor(term, 
                         levels=c("speciesCYDA", "speciesPAVI",
                                  "speciesBODA", "speciesBOGR",
                                  "speciesTHIN", "speciesSCAR", 
                                  "speciesAGST", "speciesAGCR", 
                                  "trtT"),
                        labels=c("Bermuda grass", "Switchgrass",
                                 "Buffalograss", "Blue grama",
                                 "Intermediate\nwheatgrass", 
                                 "Tall fescue", 
                                 "Creeping\nbentgrass",
                                 "Crested\nwheatgrass", 
                                 "Dust")) )  %>%
    mutate(photo= case_when(
                    term %in% c("Crested\nwheatgrass", 
                                "Creeping\nbentgrass", 
                                "Tall fescue", 
                                "Intermediate\nwheatgrass") ~ "C3",
                                T ~ "C4"))
  
print(xtable(gr_aic_df, 
               digits=c(1,1,1,1,1,1,1,1,1), 
               caption = "Results of AICc-based ranking of linear mixed-effect regression models comparing perennial grass biomass recovery by species, dust application, photosynthetic pathway (C3/C4), interactions between these variables, and a null, intercept-only model."),
      include.rownames=FALSE, floating=T, 
      sanitize.colnames.function=identity,
         comment = F) 

```

```{r GrassCIs, fig.height = 7}
gr_params %<>% arrange(photo)
ggplot(data=gr_params,
       aes(x=term)) +
    theme_bw(24) +
  geom_hline(yintercept = 0, lty=2) + 
  geom_errorbar(aes(ymin=ciL, ymax=ciU, color = photo), 
                 width=0.25, size=1.5) +
   geom_point(aes(y=estimate, fill = photo), 
              color="black", size=4.5, pch=21, stroke = 2) +
  coord_flip() +
   labs(y="Dust effect on\nbiomass recovery") +
   scale_color_manual(name="Photosynthetic\npathway", 
                      values = cbPal5[c(1:2)],
                    guide = guide_legend(
        direction = "vertical",
        title.position = "left" , 
        title.hjust = 0.5, 
        title.vjust = 1)  ) + 
   scale_fill_manual(name="Photosynthetic\npathway", 
                    values = cbPal5[c(1:2)], 
                    guide = guide_legend(
        direction = "vertical",
        title.position = "left" , 
        title.hjust = 1, 
        title.vjust = 1)  )  + 
   theme(panel.grid.major.y = element_blank(),
         panel.grid.minor.x = element_blank(),
         axis.title.y = element_blank(), 
         axis.text.y = element_text(color="black"), 
         legend.position = "bottom", 
         legend.margin = margin(0,0,0,0))  

```

\clearpage 


# R script

```{r ref.label=knitr::all_labels(!label %in% c('setup', 'grass_recovery', 'data_loading','st_crop_data_loading', 'st_CI_gg', 'st_crop_dist', 'grass_dist', 'lt_crop_dist', 'diff_gg', 'gr_full_mod_set', 'GrassCIs', 'lt_CI_gg', 'gr_tables', 'crop_mod_tab', 'st_CI_plot', 'diff_mod_comp')),echo=TRUE,eval=FALSE}
```